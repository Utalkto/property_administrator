{% extends 'tickets/templates/base.html' %} {% block main_content %}

{% load static %}


<div class="content-body">
  <!-- row -->

  <!-- Modals -->

  <input type="hidden" id="ticket-id" value="{{ticket.id}}">


  <div class="col-lg-12" id="modal-comment">
    <div class="card">
      <div class="card-body">
        <div class="bootstrap-modal">
          <div
            class="modal fade"
            id="modal-send-message"
            tabindex="-1"
            role="dialog"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    New message
                  </h5>
                  <button
                    id="close-modal"
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <div class="modal-body">
                  <div class="form-group">
                    <label for="message-subject" class="col-form-label"
                      >Subject:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="message-subject"
                    />
                  </div>
                  <div class="form-group">
                    <label for="message-text" class="col-form-label"
                      >Message:</label
                    >
                    <textarea class="form-control" id="message-text"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-dismiss="modal"
                  >
                    Close
                  </button>

                  <button
                    id="send-sms-btn"
                    type="button"
                    class="btn btn-primary sweet-success"
                    onclick="sendMessage(persoId='{{ticket.created_by.id}}', sendToTenant=true, sendByEmail=false)"
                  >
                    Send message by phone
                  </button>

                  <button
                    id="send-email-btn"
                    type="button"
                    class="btn btn-primary sweet-success"
                    onclick="sendMessage(personId='{{ticket.created_by.id}}', sendToTenant=true, sendByEmail=true)"
                  >
                    Send message by email
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  {% if ticket.ticket_status.id == 4 %}

  <div class="col-lg-12" id="modal-problem">
    <div class="card">
      <div class="card-body">
        <div class="bootstrap-modal">
          <div
            class="modal fade"
            id="modal-set-problem-as-solved"
            tabindex="-1"
            role="dialog"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    Add extra data
                  </h5>
                  <button
                    id="close-modal"
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form action="/tickets/solve-problem/{{ticket.id}}" method="post">
                <div class="modal-body">
                  {% csrf_token %}

                  <div class="form-group">
                    <label for="contractor-solution" class="col-form-label"
                      >Solution date:</label
                    >
                    <input
                      placeholder="yyyy-mm-dd"
                      type="date"
                      class="form-control"
                      id="date-problem-solved"
                      name="solution_date"
                    ></input>
                  </div>
                  <div class="form-group">
                    <label for="contractor-solution" class="col-form-label"
                      >Contractor solution:</label
                    >
                    <textarea class="form-control" id="contractor-solution" name="contractor_solution"></textarea>
                  </div>
                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-dismiss="modal"
                  >
                    Close
                  </button>

                  <button
                    id="send"
                    type="submit"
                    class="btn btn-primary"
                  >
                    Confirm
                  </button>  
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>


  {% elif ticket.ticket_status.id == 5 %}


  <div class="col-lg-12" id="modal-payment">
    <div class="card">
      <div class="card-body">
        <div class="bootstrap-modal">
          <div
            class="modal fade"
            id="modal-set-payment-as-completed"
            tabindex="-1"
            role="dialog"
            aria-labelledby="exampleModalLabel"
            aria-hidden="true"
          >
            <div class="modal-dialog" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="exampleModalLabel">
                    Add extra data
                  </h5>
                  <button
                    id="close-modal"
                    type="button"
                    class="close"
                    data-dismiss="modal"
                    aria-label="Close"
                  >
                    <span aria-hidden="true">&times;</span>
                  </button>
                </div>
                <form action="/tickets/register-payment/{{ticket.id}}" method="post">
                <div class="modal-body">
                  {% csrf_token %}

                  <div class="form-group">
                    <label for="contractor-solution" class="col-form-label"
                      >Payment date:</label
                    >
                    <input
                      placeholder="yyyy-mm-dd"
                      type="date"
                      class="form-control"
                      id="payment-date"
                      name="payment_date"
                      required
                    ></input>
                  </div>

                  <div class="form-group">
                    <label for="contractor-solution" class="col-form-label"
                      >Amount:</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="amount"
                      name="amount"
                      required
                    ></input>
                  </div>

                  <div class="form-group">
                    <label for="contractor-solution" class="col-form-label"
                      >Reference code:</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="amount"
                      name="reference_code"
                      maxlength="100"
                      required
                    ></input>
                  </div>

                  <div class="form-group">
                    <label for="contractor-solution" class="col-form-label"
                      >Notes:</label
                    >
                    <textarea
                    class="w-100 p-20 l-border-1"
                    id="note-payment-input"
                    name="notes"
                    cols="30"
                    rows="5"
                    placeholder="Write notes about the payment here"
                  ></textarea>
                  </div>


                </div>
                <div class="modal-footer">
                  <button
                    type="button"
                    class="btn btn-secondary"
                    data-dismiss="modal"
                  >
                    Close
                  </button>

                  <button
                    id="send"
                    type="submit"
                    class="btn btn-primary"
                  >
                    Confirm
                  </button>  
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
  </div>

  {% endif %}


  <!-- Information table -->

  <div class="container-fluid">
    <div class="row">
      <div class="col-lg-12">
        <div class="card">
          <div class="card-body">
            <div class="email-left-box">
              <button class="btn btn-primary btn-block">
                {{ticket.priority.string_part}}
              </button>
              <div class="mail-list mt-4">
                {% for ticket_status in ticket_statuses %}
                <a
                  href="email-inbox.html"
                  class="list-group-item border-0 p-r-0"
                >
                  <b>{{ticket_status.string_part}}</b>
                  <!-- <span class="badge badge-primary badge-sm float-right m-t-5">198</span> -->

                  {% if ticket.ticket_status.id >= ticket_status.id %}

                  <span class="badge badge-primary badge-sm float-right m-t-5">
                    <i class="fa-solid fa-check"></i>
                  </span>

                  {% endif %}
                </a>
                {% endfor %}
              </div>
            </div>

            <div class="email-right-box">
              <div class="toolbar" role="toolbar">
                <div class="btn-group m-b-20">
                  <button type="button" class="btn btn-light">
                    <i class="fa fa-archive"></i>
                  </button>
                  <button type="button" class="btn btn-light">
                    <i class="fa fa-exclamation-circle"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-light"
                    id="button_delete"
                  >
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </div>
              <div class="read-content">
                <div class="media pt-5">
                  <!-- <img class="mr-3 rounded-circle" src="images/avatar/1.jpg" /> -->
                  <div class="media-body">
                    <h3 class="m-b-3">{{ticket.created_by.name}}</h3>

                    <p class="m-b-2">
                      <strong>Date created:</strong> {{ticket.date_opened}}
                    </p>
                    <p class="m-b-2">
                      <strong>Ticket type:</strong>
                      {{ticket.ticket_type.string_part}}
                    </p>

                    {% if ticket.problem.string_part %}

                    <p class="m-b-2">
                      <strong> Problem:</strong> {{ticket.problem.string_part}}
                    </p>

                    {% else %}

                    <p class="m-b-2">
                      <strong>Problem:</strong> No identified yet
                    </p>

                    {% endif %} {% if ticket.contractor.name %}

                    <p class="m-b-2">
                      <strong> Contractor:</strong> {{ticket.contractor.name}}
                    </p>

                    {% else %}

                    <p class="m-b-2">
                      <strong>Contractor:</strong> No selected yet
                    </p>

                    {% endif %}
                  </div>
                </div>
                <hr />
                <div class="media mb-4 mt-1">
                  <div class="media-body">
                    <span class="float-right"></span>
                    <h4 class="m-0 text-primary">
                      {{ next_to_do.string_part }}
                    </h4>
                  </div>
                </div>
                <h5 class="m-b-15">
                  Hi, {{request.user.get_full_name}}, here is what you need to do next:
                </h5>
                <p>{{next_to_do.info}}</p>

                <h4>Action to do</h4>

                {% for key, value in ticket.action_to_do.action_to_do.items %}

                <p><strong>{{key}}</strong> : {{value}}</p>

                {% endfor %} 

                      
                {% if ticket.ticket_status.id == 4 %}

                <button
                  type="button"
                  class="btn mb-1 btn-primary"
                  id="mark-problem-as-completed"
                  data-target="#modal-set-problem-as-solved"
                  data-toggle="modal"
                > Mark problem as solved</button>

                {% elif ticket.ticket_status.id == 5 %}

                <button
                  type="button"
                  class="btn mb-1 btn-primary"
                  id="set-payment-as-completed"
                  data-target="#modal-set-payment-as-completed"
                  data-toggle="modal"
                > Mark payment as completed </button>


                {% elif ticket.ticket_status.id == 6 %}

                <button
                  type="button"
                  class="btn mb-1 btn-primary"
                  id="close-ticket"
                > Close ticket </button>

                {% else %}

                <a
                class="badge badge-primary badge-sm m-t-5"
                href="{{next_to_do.action_link}}{{ticket.ticket_type.id}}/{{ticket.id}}"
                >
                  {{next_to_do.string_part}}
                </a>

                {% endif %}

                <hr />

                <button
                  type="button"
                  class="btn mb-1 btn-primary"
                  data-target="#modal-send-message"
                  data-toggle="modal"
                >
                  Send message to tenant
                  <span class="btn-icon-right">
                    <i class="fa-solid fa-envelope"></i>
                  </span>
                </button>

                <hr />

                <div id="comments-section">
                  <h4 class="p-t-15">Write a comment</h4>
                  <hr />

                  <div class="form-group p-t-15">
                    <textarea
                      class="w-100 p-20 l-border-1"
                      name=""
                      id="comment-input"
                      cols="30"
                      rows="5"
                      placeholder="Write your comment here"
                    ></textarea>
                  </div>
                </div>
                <div class="text-right">
                  <button
                    class="btn btn-primaryw-md m-b-30"
                    type="button"
                    onclick="makeComment(ticketId='{{ticket.id}}')"
                  >
                    Submmit
                  </button>
                </div>

                <hr />

                {% if comments %}

                <h4 id="ticket-comments-title">Ticket Comments</h4>

                {% endif %}

                <div id="comments-made">
                  {% for comment in comments %}
                  <hr />

                  <p><strong>Created at : {{comment.date}}</strong></p>
                  <p>
                    <strong>Made by : {{comment.made_by.get_full_name}}</strong>
                  </p>

                  <p>{{comment.comment}}</p>

                  <hr />

                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock %} {% block local_js %}

<script src="{% static 'js/general/main.js' %}"></script>
<script src="{% static 'js/create-ticket/ticketInfo.js' %}"></script>
<script src="{% static 'js/sweetalert.min.js' %}"></script>

{% endblock %}
